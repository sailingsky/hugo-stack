<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Redis on 码文</title><link>https://sailingsky.github.io/tags/redis/</link><description>Recent content in Redis on 码文</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 15 Jan 2024 15:56:26 +0800</lastBuildDate><atom:link href="https://sailingsky.github.io/tags/redis/index.xml" rel="self" type="application/rss+xml"/><item><title>redis集群高可用</title><link>https://sailingsky.github.io/p/redis%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/</link><pubDate>Mon, 15 Jan 2024 15:56:26 +0800</pubDate><guid>https://sailingsky.github.io/p/redis%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/</guid><description>&lt;img src="https://sailingsky.github.io/p/redis%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/Logo-redis.svg.png" alt="Featured image of post redis集群高可用" />&lt;h4 id="安装">安装
&lt;/h4>&lt;h5 id="下载源码包编译">下载源码包&amp;amp;编译
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">wget https://download.redis.io/redis-7.2.3.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxf redis-7.2.3.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> redis-7.2.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="修改配置redisconf">修改配置redis.conf
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#禁用保护模式，生产勿用！
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">protected-mode no
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="主从模式">主从模式
&lt;/h4>&lt;p>&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151435857.png"
loading="lazy"
alt="image.png"
>&lt;/p>
&lt;h5 id="主节点">主节点：
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./src/redis-server /data/redis-master1/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="从节点">从节点：
&lt;/h5>&lt;ul>
&lt;li>修改redis.conf中端口相关及主从复制主节点配置
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">port 6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># replicaof 主节点IP 主节点端口 replicaof 127.0.0.1 6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replicaof 127.0.0.1 6379
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>也可以直接在从节点客户端执行命令：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">redis&amp;gt; replicaof 127.0.0.1 &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>启动从节点后，可在日志输出中看到主从同步成功。
&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151236726.png"
loading="lazy"
alt="image.png"
>&lt;/li>
&lt;/ul>
&lt;h5 id="验证">验证
&lt;/h5>&lt;p>主节点：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> &lt;span class="nb">test&lt;/span> this is a key
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>从节点：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./src/redis-cli -p &lt;span class="m">6380&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1:6380&amp;gt; get &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151253772.png"
loading="lazy"
alt="image.png"
>&lt;/p>
&lt;h4 id="哨兵模式">哨兵模式
&lt;/h4>&lt;p>&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151507768.png"
loading="lazy"
alt="image.png"
>&lt;/p>
&lt;h5 id="配置哨兵节点">配置哨兵节点
&lt;/h5>&lt;p>配置sentinel.conf文件,其他哨兵也参考该配置进行修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># sentinel节点端口号
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">port 26379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># sentinel monitor 被监控主节点名称 主节点IP 主节点端口 quorum
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sentinel monitor mymaster 127.0.0.1 6379 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># sentinel down-after-milliseconds 被监控主节点名称 毫秒数
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sentinel down-after-milliseconds mymaster 60000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># sentinel failover-timeout 被监控主节点名称 毫秒数
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sentinel failover-timeout mymaster 180000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="启动哨兵节点">启动哨兵节点
&lt;/h5>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost redis-sentinal1&lt;span class="o">]&lt;/span>&lt;span class="c1"># ./src/redis-sentinel /data/redis-sentinal1/sentinel.conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其余的哨兵节点也类似。&lt;/p>
&lt;h5 id="验证-1">验证
&lt;/h5>&lt;p>将master 6379 kill掉，在哨兵节点的日志中可查看到选举主节点的信息：
&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151515725.png"
loading="lazy"
alt="image.png"
>&lt;/p>
&lt;h4 id="cluster集群模式">cluster集群模式
&lt;/h4>&lt;p>Redis Cluster 功能 ： &lt;strong>负载均衡，故障切换&lt;/strong>，&lt;strong>主从复制&lt;/strong> 。&lt;/p>
&lt;p>配置节点：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># cluster节点端口号,从6700-6705
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">port 6700
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 开启集群模式
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cluster-enabled yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 节点超时时间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cluster-node-timeout 15000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>分别启动各个节点：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./src/redis-server /data/redis-cluster1/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建cluster&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./src/redis-cli -p &lt;span class="m">6700&lt;/span> --cluster create 127.0.0.1:6700 127.0.0.1:6701 127.0.0.1:6702 127.0.0.1:6703 127.0.0.1:6704 127.0.0.1:6705 --cluster-replicas &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建成功后会显示集群和节点信息。
&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151546513.png"
loading="lazy"
alt="image.png"
>
也可通过redis客户端执行下面命令，查看集群信息&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cluster info
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://wechapter.oss-cn-hangzhou.aliyuncs.com/wechat/image202401151548911.png"
loading="lazy"
alt="image.png"
>&lt;/p>
&lt;h5 id="错误异常解决">错误异常解决
&lt;/h5>&lt;p>如果在配置集群时，启动出现 &lt;code>[ERR] Node 127.0.0.1:6700 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.&lt;/code>。这是由于节点中存在以前旧数据导致。&lt;/p>
&lt;p>解决方式：&lt;/p>
&lt;ul>
&lt;li>停掉所有节点&lt;/li>
&lt;li>删除各节点的nodes.conf 和dump.rdb文件&lt;/li>
&lt;li>重新启动所有节点&lt;/li>
&lt;li>重新创建集群&lt;/li>
&lt;/ul></description></item></channel></rss>